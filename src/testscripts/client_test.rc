#!/opt/local/bin/rc

BOOTSTRAP=sys15
ACCEPTORS=(sys04 sys05 sys07 sys08 sys09)
REPLICAS=(sys15 sys11 sys12 sys13 sys14)
CLIENTS=(sys15 sys11 sys12 sys13 sys14 sys01 sys04 sys05 sys07 sys08 sys09 sys10)
DOMAINSUFFIX=.systems.cs.cornell.edu
BASE=/local/concoord-deniz
CONCOORDDIR=/home/deniz/concoord
PYTHON=python

#### YOU SHOULD NOT HAVE TO CHANGE ANYTHING BELOW THIS LINE

# This script starts a given number of replica nodes, and acceptor nodes
# and a client node on sys cluster.
if (test $#* -ne 3) {
  echo "Usage: `basename $0` number-of-replicas number-of-acceptors number-of-clients" 
  exit 1
}

CONCOORDR=$CONCOORDDIR/replica.py
CONCOORDA=$CONCOORDDIR/acceptor.py
CONCOORDC=$CONCOORDDIR/client.py

BOOTSTRAP=$BOOTSTRAP^$DOMAINSUFFIX
ACCEPTORS=$ACCEPTORS^$DOMAINSUFFIX
REPLICAS=$REPLICAS^$DOMAINSUFFIX
CLIENT=$CLIENT^$DOMAINSUFFIX

#
# execute the given command on the host, redirecting output appropriately
#
fn docmd {
    host=$1
    cmd=$2
    LOGFILE=$BASE/concoord.log.$host
    cmd= $cmd ^ ' >' ^ $LOGFILE ^ ' 2>&1 &'
    ssh deniz@$host $cmd
    echo $host
}

numreplicas=`{expr $1 - 1}
numacceptors= $2
numclients= $3

docmd $BOOTSTRAP 'nohup ' ^ $PYTHON ^ ' ' ^ $CONCOORDR ^ ' -o bank'
sleep 3

while(expr $numreplicas '>' 0 >/dev/null) {
    hostindex=`{expr $numreplicas % $#REPLICAS + 1}
    docmd $REPLICAS($hostindex) 'nohup ' ^ $PYTHON ^ ' ' ^ $CONCOORDR ^ ' -b ' ^ $BOOTSTRAP ^ ':6668' ^ ' -o bank'
    numreplicas=`{expr $numreplicas - 1}
}
sleep 3

while(expr $numacceptors '>' 0 >/dev/null) {
    hostindex=`{expr $numacceptors % $#ACCEPTORS + 1}
    docmd $ACCEPTORS($hostindex) 'nohup ' ^ $PYTHON ^ ' ' ^ $CONCOORDA ^ ' -b ' ^ $BOOTSTRAP ^ ':6668'
    numacceptors=`{expr $numacceptors - 1}
}
sleep 3

while(expr $numclients '>' 0 >/dev/null) {
    replicaindex=`{expr $numclients % $#REPLICAS + 1}
    hostindex=`{expr $numclients % $#CLIENTS + 1}
    docmd $CLIENTS($hostindex) 'nohup ' ^ $PYTHON ^ ' ' ^ $CONCOORDC ^ ' -b ' ^ $BOOTSTRAP ^ ':6668 ' ^ '<' ^ $CONCOORDDIR ^ '/clientinputs/bank -c ' ^ $numclients
    numclients=`{expr $numclients - 1}
}
